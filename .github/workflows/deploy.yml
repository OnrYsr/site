name: Deploy to Raspberry Pi

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Manuel tetikleme iÃ§in

jobs:
  deploy:
    name: Deploy to Raspberry Pi Production
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
        
    - name: Deploy to Raspberry Pi (Self-Hosted)
      run: |
        set -e  # Exit on any error
        
        echo "ğŸš€ Starting self-hosted Raspberry Pi deployment..."
        echo "ğŸ“ Working directory: $(pwd)"
        
        # Navigate to project directory
        cd /home/muse3dstudio/muse3dstudio/web-app
        echo "ğŸ“‚ Current directory: $(pwd)"
        
        # Backup current code
        echo "ğŸ’¾ Backing up current code..."
        cp -r . ../web-app-backup-$(date +%Y%m%d-%H%M%S) || echo "Backup failed, continuing..."
        
        # Update code from GitHub
        echo "â¬‡ï¸ Updating code from repository..."
        git stash push -m "Auto-stash before deployment $(date)" || echo "Nothing to stash"
        git pull origin main
        echo "âœ… Code updated from GitHub"
        
        # Install dependencies
        echo "ğŸ“¦ Installing dependencies..."
        npm install --production=false
        echo "âœ… Dependencies installed"
        
        # Fix environment file for native execution
        echo "ğŸ”§ Fixing environment configuration..."
        echo "ğŸ“‹ Current .env content (before fix):"
        cat .env 2>/dev/null || echo "No .env file found"
        
        if [ -f .env ]; then
          # Create backup and replace database URL completely
          cp .env .env.backup
          # Remove any existing DATABASE_URL line and add the correct one
          grep -v "^DATABASE_URL" .env > .env.tmp || true
          echo 'DATABASE_URL="postgresql://postgres:postgres123@localhost:5432/muse3dstudio"' >> .env.tmp
          mv .env.tmp .env
          echo "âœ… Environment fixed for native execution"
        else
          echo "âš ï¸ .env file not found, creating from example..."
          cp env.production.example .env
          # Remove any existing DATABASE_URL line and add the correct one
          grep -v "^DATABASE_URL" .env > .env.tmp || true
          echo 'DATABASE_URL="postgresql://postgres:postgres123@localhost:5432/muse3dstudio"' >> .env.tmp
          mv .env.tmp .env
          echo "âœ… Environment created and fixed"
        fi
        
        echo "ğŸ“‹ Fixed .env DATABASE_URL:"
        grep "DATABASE_URL" .env || echo "No DATABASE_URL found in .env"
        
        # Ensure Docker services are running FIRST
        echo "ğŸ³ Starting Docker services..."
        docker compose up -d postgres redis
        echo "âœ… Database services started"
        
        # Wait for PostgreSQL to be ready
        echo "â³ Waiting for PostgreSQL to be ready..."
        timeout=60
        while ! docker compose exec postgres pg_isready -U postgres > /dev/null 2>&1; do
          sleep 2
          timeout=$((timeout - 2))
          if [ $timeout -le 0 ]; then
            echo "âŒ PostgreSQL failed to start within 60 seconds"
            exit 1
          fi
        done
        echo "âœ… PostgreSQL is ready"
        
        # Generate Prisma client
        echo "ğŸ—„ï¸ Generating Prisma client..."
        npx prisma generate
        echo "âœ… Prisma client generated"
        
        # Update database schema
        echo "ğŸ—„ï¸ Updating database schema..."
        npx prisma db push
        echo "âœ… Database schema updated"
        
        # Seed database with categories and products
        echo "ğŸŒ± Seeding database with updated categories and products..."
        npm run db:seed
        echo "âœ… Database seeded with new data"
        
        # Update systemd services if changed (try without sudo first, fallback to sudo)
        echo "ğŸ”§ Updating systemd services..."
        cp systemd/muse3d-web.service /etc/systemd/system/ 2>/dev/null || sudo cp systemd/muse3d-web.service /etc/systemd/system/ || echo "Service file not changed"
        cp systemd/cloudflare-tunnel.service /etc/systemd/system/ 2>/dev/null || sudo cp systemd/cloudflare-tunnel.service /etc/systemd/system/ || echo "Tunnel service not changed"
        systemctl daemon-reload 2>/dev/null || sudo systemctl daemon-reload || echo "Could not reload systemd"
        echo "âœ… Systemd services updated"
        
        # Restart web application service
        echo "ğŸ”„ Restarting web application..."
        systemctl restart muse3d-web.service 2>/dev/null || sudo systemctl restart muse3d-web.service || echo "Could not restart web service"
        echo "âœ… Web service restarted"
        
        # Restart Cloudflare tunnel (if needed)
        echo "ğŸ”— Checking tunnel service..."
        systemctl restart cloudflare-tunnel.service 2>/dev/null || sudo systemctl restart cloudflare-tunnel.service || echo "Could not restart tunnel service"
        echo "âœ… Tunnel service restarted"
        
        # Wait for services to be ready
        echo "â³ Waiting for services to start..."
        sleep 15
        
        # Check service status
        echo "ğŸ“Š Service status:"
        systemctl is-active muse3d-web.service 2>/dev/null || sudo systemctl is-active muse3d-web.service || echo "Could not check web service"
        systemctl is-active cloudflare-tunnel.service 2>/dev/null || sudo systemctl is-active cloudflare-tunnel.service || echo "Could not check tunnel service"
        
        # Check if the app is responding
        echo "ğŸŒ Testing application health..."
        curl -f http://localhost:3000/api/health > /dev/null 2>&1 && echo "âœ… App healthy and responding" || echo "âš ï¸ Health check failed"
        
        echo "ğŸ‰ Self-hosted Raspberry Pi deployment completed successfully!"
        
    - name: Verify deployment
      run: |
        echo "ğŸŒ Verifying self-hosted Raspberry Pi deployment..."
        
        # Wait for services to be fully ready
        sleep 20
        
        # Check local health first
        local_health=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/api/health || echo "000")
        echo "ğŸ  Local health response: $local_health"
        
        # Check if site is responding via domain
        response=$(curl -s -o /dev/null -w "%{http_code}" https://muse3dstudio.com || echo "000")
        echo "ğŸ“Š Domain response code: $response"
        
        # Check health endpoint specifically
        health_response=$(curl -s -o /dev/null -w "%{http_code}" https://muse3dstudio.com/api/health || echo "000")
        echo "ğŸ¥ Domain health endpoint response: $health_response"
        
        if [ "$local_health" = "200" ] && [ "$response" = "200" ] && [ "$health_response" = "200" ]; then
          echo "âœ… Self-hosted Raspberry Pi deployment successful! Site is live and healthy."
        elif [ "$response" = "502" ] || [ "$response" = "503" ]; then
          echo "âš ï¸ Site is showing $response - services might still be starting up"
        else
          echo "âŒ Deployment verification failed - response codes: local=$local_health, site=$response, health=$health_response"
        fi
        
        echo "ğŸ‰ Self-hosted Raspberry Pi deployment verification completed"
